#!/usr/bin/env bash

generate_deployment() {
    deployment="$1"

    # lock_image_storage u

    install_path() {
        ts="${1##* }" && [[ ! "${ts:0:1}" == "/" ]] && return
        [[ ! -d ".store/surface/$deployment$(dirname "${1##* }")" ]]  && 
            mkdir -p ".store/surface/$deployment$(dirname "${1##* }")"
        link ".store/deep/${1%% *}" ".store/surface/$deployment${1##* }" 2>/dev/null || :
    }

    export -f install_path
    export deployment

    printf "Installing deployment...\n"
    cat ".$deployment" | xargs -0 -n1 -P"$(("$(nproc --all)"**2))" \
        bash -c 'install_path "$@"' _

    unset -f install_path

    mkdir -p "/usr/local"
    cp -rfa "/etc" ".store/surface/$deployment" || :
    rm ".store/surface/$deployment/etc/resolv.conf"
    ln -sf "/run/systemd/resolve/stub-resolv.conf" \
        ".store/surface/$deployment/etc/resolv.conf" || :

    echo "$deployment" > ".store/surface/$deployment/usr/.mat_dep"
    echo "$deployment" > ".store/surface/$deployment/usr/.ald_dep"

    # lock_image_storage l
}

relabel_store() {
    deployment="$1"

    # lock_image_storage u

    printf "Relabeling deployment %s packages...\n" "$deployment"

    find ".store/surface/$deployment" -mindepth 2 -maxdepth 2 -print0 | sort -zr | \
        xargs -0 -I{} -P"$(("$(nproc --all)"/2))" setfiles -r ".store/surface/$deployment" \
        ".store/surface/$deployment/etc/selinux/targeted/contexts/files/file_contexts" {} &>/dev/null

    chcon -t usr_t ".store/surface/$deployment/usr" &>/dev/null
    chcon -t etc_t ".store/surface/$deployment/etc" &>/dev/null

    # lock_image_storage l
}
