#!/usr/bin/env bash
set -oue pipefail

get_unused_packages() {
    read -ra pkg_files <<< "$(find . -maxdepth 1 -type f -name "pkgs*" | tr "\n" " ")"

    depl_pkgs="$(cat "${pkg_files[@]}" | sort -u)"
    store_pkgs="$(find .store -maxdepth 1 -type d ! -path ".store" | cut -d/ -f2 | sort)"

    echo -e "$depl_pkgs\n$store_pkgs" | sort | uniq -u | grep -v "filesystem-.*"
}

prune_unused_packages() {
    if [[ -f .current && "$(cat .current)" != "" ]]; then
        failed="$(cat .current)"
        printf "Cleaning up failed packages...\n"
        cat .current | xargs -I{} -P"$(("$(nproc --all)"/2))" rm -rf .store/{}
        echo "" > ./.current
    fi

    prune_pkg() {
        pkg="$1"

        printf "Pruning $pkg...\n"
        echo "$pkg" >> .current
        rm -rf ".store/$pkg"
        sed -i "s/^$pkg//" .current
    }

    prune_pkgs() {
        xargs -n1 -P"$(("$(nproc --all)"/2))" bash -c 'prune_pkg "$@"' _ <<< "$@"
    }

    export -f prune_pkg
    export -f prune_pkgs

    get_unused_packages | xargs -n"$(("$(nproc --all)"*2))" -P"$(("$(nproc --all)"/2))" \
        bash -c 'prune_pkgs "$@"' _

    unset -f prune_pkg
    unset -f prune_pkgs
}
